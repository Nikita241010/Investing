import requests
import json
import telebot
from telebot import types

# Replace with your OpenRouter API key
API_KEY = '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'
API_URL = 'https://openrouter.ai/api/v1/chat/completions'

token = "7796348346:AAE5MxgCkbE-_thS3J7KDylJ_OyuZINkoNw"

bot = telebot.TeleBot(token)

person = ''
year = ''
input = False

def gpt(response):
    # Define the headers for the API request
    headers = {
        'Authorization': f'Bearer {API_KEY}',
        'Content-Type': 'application/json'
    }

    # Define the request payload (data)
    data = {
        "model": "deepseek/deepseek-chat-v3.1",
        "messages": [{"role": "user", "content": response}]
    }

    # Send the POST request to the DeepSeek API
    response = requests.post(API_URL, json=data, headers=headers)

    # Check if the request was successful
    if response.status_code == 200:
        response_data = response.json()
        # Теперь извлекаем только текст ответа
        message_content = response_data['choices'][0]['message']['content']
        return message_content
    else:
        print("Failed to fetch data from API. Количество запросов в бесплатной версии закончилось, для продолжения пользования требуется оплата")

def generate_answer(person, year):
    body = f'Тезисно изложи предсказания {person} по росту/падению криптовалюте за {year} год,' \
    'в ответе говори только сухие факты, ничего лишнего, а затем напиши процент сбывшихся предсказаний(если цена среагировала на заявление в ожидаемую сторону то сбылось),' \
    'Ответ должен выглядеть так: Такой то человек в таком то году говорил что и дальше пунктами тезисы что он ' \
    'говорил касательно роста или падения определённых монет(К примеру, такой то человек заявил что по его мнению' \
    ' такая то монета будет расти потому что и т.д. или заявил что-то что должно указывать на рост/падение такой то монеты), а затем после этого, Из его предсказания сбылось только ' \
    'столько то. '
    return gpt(body)

@bot.message_handler(commands=['start'])
def start_message(message):
    markup = types.InlineKeyboardMarkup()
    button1 = types.InlineKeyboardButton('Ввести полное имя человека для анализа', callback_data='button1')
    markup.row(button1)
    bot.send_message(message.chat.id, 'Привет', reply_markup=markup)
    

def generate_new_buttons():
    markup = types.InlineKeyboardMarkup(row_width=1)
    markup.add(
        types.InlineKeyboardButton('2021', callback_data='new_button1'),
        types.InlineKeyboardButton('2022', callback_data='new_button2'),
        types.InlineKeyboardButton('2023', callback_data='new_button3'),
        types.InlineKeyboardButton('2024', callback_data='new_button4'),
        types.InlineKeyboardButton('2025', callback_data='new_button5')
    )
    return markup


@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    global person, year, input
    if call.data == 'button1':
        input = True
    elif call.data == 'new_button1':  
        year = '2021'
        bot.send_message(call.message.chat.id,"Пожалуйста, подожтите немного пока мы ищем для вас информацию")
        message = generate_answer(person, year)
        bot.send_message(call.message.chat.id, message)
    elif call.data == 'new_button2':  
        year = '2022'
        bot.send_message(call.message.chat.id,"Пожалуйста, подожтите немного пока мы ищем для вас информацию")
        message = generate_answer(person, year)
        bot.send_message(call.message.chat.id, message)
    elif call.data == 'new_button3':  
        year = '2023'
        bot.send_message(call.message.chat.id,"Пожалуйста, подожтите немного пока мы ищем для вас информацию")
        message = generate_answer(person, year)
        bot.send_message(call.message.chat.id, message)
    elif call.data == 'new_button4':  
        year = '2024'
        bot.send_message(call.message.chat.id,"Пожалуйста, подожтите немного пока мы ищем для вас информацию")
        message = generate_answer(person, year)
        bot.send_message(call.message.chat.id, message)
    elif call.data == 'new_button5':  
        year = '2025'
        bot.send_message(call.message.chat.id,"Пожалуйста, подожтите немного пока мы ищем для вас информацию")
        message = generate_answer(person, year)
        bot.send_message(call.message.chat.id, message)

@bot.message_handler(content_types=['text'])
def handle_message(message):
    global input, user_data, person
    if input == True:
        person = message.text
        new_buttons = generate_new_buttons()
        bot.send_message(message.chat.id,'Выберите год:', reply_markup=new_buttons)
        input = False
        


bot.infinity_polling()
